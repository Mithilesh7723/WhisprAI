
/**
 * @fileOverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset prioritizes a secure-by-default posture, emphasizing explicit authorization checks for all write operations.
 * It enforces a separation of concerns, using different collections for public and private data.
 * The rules are designed to be auditable and maintainable through the use of helper functions.
 *
 * Data Structure:
 * - /posts/{postId}: Publicly readable collection of user-generated content. Write access is restricted.
 * - /hidden_posts/{postId}: Private collection for posts hidden by admins. Only accessible by admins.
 * - /aiChats/{aiChatId}: Publicly readable collection of AI chat sessions. Write access is open to facilitate chat functionality.
 * - /roles_admin/{adminId}: Collection of admin user IDs.
 * - /adminActions/{adminActionId}: Logs of actions performed by admins.
 *
 * Key Security Decisions:
 * - The /posts collection is publicly readable, which is safe because it only contains non-hidden posts.
 * - The /hidden_posts collection is strictly limited to admin access.
 * - Data validation is limited to authorization-critical fields to enable rapid prototyping.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Publicly readable collection of non-hidden posts.
     * Anyone can read. Only authenticated users can create. Only owners/admins can update/delete.
     * @path /posts/{postId}
     */
    match /posts/{postId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if (isSignedIn() && isExistingOwner(resource.data.userId)) || isAdmin();
    }
    
    /**
     * @description Private collection for hidden posts. Only admins have access.
     * @path /hidden_posts/{postId}
     */
    match /hidden_posts/{postId} {
        allow read, write: if isAdmin();
    }

    /**
     * @description Admins have full read/write. Anyone can read/list chats. Only the chat owner can create, update, or delete their own chat.
     * @path /aiChats/{aiChatId}
     */
    match /aiChats/{aiChatId} {
      allow read, write: if isAdmin();
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(resource.data.userId);
    }

    /**
    * @description Only authenticated admins can read/write admin roles. A user can create their own admin doc to "request" promotion.
     * @path /roles_admin/{adminId}
     */
    match /roles_admin/{adminId} {
      allow read, write: if isAdmin();
      allow create: if request.auth.uid == adminId;
    }

    /**
     * @description Only authenticated admins can create, read, update, or delete admin actions.
     * @path /adminActions/{adminActionId}
     */
    match /adminActions/{adminActionId} {
      allow read, write: if isAdmin();
      allow create: if isAdmin() && request.resource.data.adminId == request.auth.uid;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
        return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null && resource.data.userId == userId;
    }

    function isAdmin() {
        return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}
